<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Local VR Heart Rate</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
      #ui {
        position: absolute;
        width: 100%;
        text-align: center;
        top: 30px;
        color: white;
        font-family: sans-serif;
        z-index: 10;
      }
      button {
        font-size: 1.4em;
        padding: 10px 20px;
        border-radius: 12px;
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <div id="ui">
      <button id="connect">Connect Heart Rate</button>
      <div id="bpm" style="margin-top: 20px; font-size: 3em;">-- bpm</div>
    </div>

    <a-scene>
      <a-entity camera look-controls position="0 1.6 0"></a-entity>
      <a-sky color="#111"></a-sky>
      <a-text id="vrBpm"
              value="-- bpm"
              color="#FF69B4"
              position="0 2 -2"
              align="center"
              width="4">
      </a-text>
    </a-scene>

    <script>
      const bpmText = document.getElementById('bpm');
      const vrText = document.getElementById('vrBpm');

      async function connectHeartRate() {
        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['heart_rate'] }]
          });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService('heart_rate');
          const char = await service.getCharacteristic('heart_rate_measurement');
          await char.startNotifications();

          char.addEventListener('characteristicvaluechanged', e => {
            const val = e.target.value;
            const bpm = val.getUint8(1);
            bpmText.textContent = bpm + ' bpm';
            vrText.setAttribute('value', bpm + ' bpm');
          });

          bpmText.textContent = "Connected... waiting data";
        } catch (err) {
          bpmText.textContent = "Connection failed: " + err;
        }
      }

      document.getElementById('connect').addEventListener('click', connectHeartRate);
    </script>
  </body>
</html>
